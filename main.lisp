(in-package :yashmup)

(defun load-player-ship-image ()
  (let ((ship-image-path (merge-pathnames #p"player-ship.png" *resource-path*)))
    (sdl-image:load-image (namestring ship-image-path) :alpha 255)))

(defun load-laser-image ()
  (let ((laser-path (merge-pathnames "laser.png" *resource-path*)))
    (sdl-image:load-image (namestring laser-path) :alpha 255)))

(defun main ()
  (setf *running* t)
  (sdl:with-init (sdl:sdl-init-video)
    (sdl:initialise-default-font)
    (sdl:window *screen-width* *screen-height*
		:title-caption "PEW PEW"
		:icon-caption "PEW PEW")
    (setf (sdl:frame-rate) 60)
    (sdl:clear-display *bg-color*)
    (let ((*player-ship-image* (load-player-ship-image))
	   (*laser-image* (load-laser-image)))
      (declare (special *player-ship-image* *laser-image*))
      (let ((player-ship (make-instance 'player-ship)))
      	(sdl:with-events ()
	  (:quit-event () (prog1 t
			    (setf *running* nil)))
	  (:key-down-event (:key key)
			   (handle-key-down key))
	  (:key-up-event (:key key)
			 (handle-key-up key))
	  (:idle ()
		 (sdl:clear-display *bg-color*)
		 (when (firing-p player-ship)
		   (push (make-instance 'laser
					:x-loc (+ 25 (x-loc player-ship))
					:y-loc (+ (y-loc player-ship) 35)
					:shooter player-ship)
			 (shots player-ship)))
		 (mapcar #'update (shots player-ship))
		 (update player-ship)
		 (mapcar #'draw (shots player-ship))
		 (draw player-ship)
		 (sdl:update-display)
		 (when (not *running*)
		   (sdl:push-quit-event))))))))