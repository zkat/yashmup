(in-package :yashmup)

(defun main ()
  (setf *running* t)
  (sdl:with-init (sdl:sdl-init-video)
    (sdl:initialise-default-font)
    (sdl:window *screen-width* *screen-height*
		:title-caption "PEW PEW"
		:icon-caption "PEW PEW")
    (setf (sdl:frame-rate) 60)
    (sdl:clear-display *bg-color*)
    (init-resources)
    (play-game)))

(defun play-game ()
    (let ((*player-ship-image* (load-player-ship-image))
	   (*laser-image* (load-laser-image)))
      (declare (special *player-ship-image* *laser-image*))
      (let ((player-ship (make-instance 'player-ship))
	    (enemy (make-instance 'enemy)))
      	(sdl:with-events ()
	  (:quit-event () (prog1 t
			    (setf *running* nil)))
	  (:key-down-event (:key key)
			   (handle-key-down key))
	  (:key-up-event (:key key)
			 (handle-key-up key))
	  (:idle ()
		 (sdl:clear-display *bg-color*)
		 (mapc #'update *projectiles*)
		 (update player-ship)
		 (mapc (lambda (pew)
			 (when (collided-p enemy pew)
			   (format t "OW ")
			   (setf *projectiles* (delete pew *projectiles*))))
		       *projectiles*)
		 (mapc #'draw *projectiles*)

		 (draw enemy)
		 (draw player-ship)
		 (sdl:update-display)
		 (when (not *running*)
		   (sdl:push-quit-event)))))))